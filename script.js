// 文章数据
const articles = {
    'Office激活工具使用教程': {
        id: 'office-activation-guide',
        title: 'Office激活工具使用教程',
        date: '2024-03-20',
        readTime: '10分钟阅读',
        category: '软件教程',
        image: 'images/officeb.png',
        downloadUrl: 'https://share.feijipan.com/s/QPZqPPsL?code=LYZ6',
        content: `
            <h3>Office激活工具简介</h3>
            <p>这款Office激活工具是专为Mac用户设计的简单易用的激活解决方案，只需几步操作即可完成Office套件的激活。</p>
            
            <h3>准备工作</h3>
            <ul>
                <li>确保已安装Office for Mac（2016、2019或2021版本）</li>
                <li>下载并解压Office激活工具（.iso文件）</li>
                <li>关闭所有Office应用程序</li>
                <li>确保Mac系统版本在10.13或以上</li>
            </ul>
            
            <h3>激活步骤</h3>
            <ol>
                <li>双击打开下载的.iso文件</li>
                <li>将激活工具拖拽到"应用程序"文件夹</li>
                <li>打开"应用程序"文件夹，右键点击激活工具选择"打开"</li>
                <li>在弹出的窗口中点击"开始激活"按钮</li>
                <li>等待激活过程完成（约1-2分钟）</li>
                <li>重启Office应用程序验证激活状态</li>
            </ol>
            
            <h3>注意事项</h3>
            <div style="background: rgba(250, 128, 114, 0.1); border-left: 4px solid #FA8072; padding: 15px; margin: 15px 0; border-radius: 4px;">
                <p style="color: #FA8072; font-weight: 600; margin-bottom: 8px;">重要提醒：</p>
                <ul style="color: rgba(255, 255, 255, 0.85);">
                    <li>激活前请备份重要数据</li>
                    <li>确保网络连接稳定</li>
                    <li>如遇问题，可尝试重新启动Mac后再试</li>
                    <li>本工具仅用于学习测试目的</li>
                </ul>
            </div>
            
            <h3>常见问题解答</h3>
            <div style="background: rgba(250, 128, 114, 0.08); border: 1px solid rgba(250, 128, 114, 0.2); padding: 15px; margin: 15px 0; border-radius: 8px;">
                <p><strong style="color: #FA8072;">Q: 激活后Office提示未激活？</strong><br>
                A: 请尝试重新运行激活工具，并确保Office应用程序完全关闭。</p>
                
                <p><strong style="color: #FA8072;">Q: 激活工具无法打开？</strong><br>
                A: 在"系统偏好设置 > 安全性与隐私"中允许运行未识别的应用程序。</p>
            </div>
            
            <div style="background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50; padding: 15px; margin: 20px 0; border-radius: 4px;">
                <p style="color: #4CAF50; font-weight: 600; margin-bottom: 8px;">
                    <i class="fas fa-download" style="margin-right: 8px;"></i>
                    相关软件下载
                </p>
                <p style="color: rgba(255, 255, 255, 0.85);">
                    本文提到的Office激活工具可以在下载页面获取。点击下方按钮前往下载。
                </p>
            </div>
        `
    },
    '电脑工具软件破解指南': {
        id: 'pc-tool-crack-guide',
        title: '电脑工具软件破解指南',
        date: '2024-03-18',
        readTime: '20分钟阅读',
        category: '设备破解',
        image: 'images/misakaXb.jpeg',
        downloadUrl: 'https://share.feijipan.com/s/X1ZqP2yW?code=LYZ6',
        content: `
            <h3>工具简介</h3>
            <p>这款电脑工具软件能够为iPad和iPhone设备解锁高级功能，支持多种设备型号和iOS版本。</p>
            
            <h3>所需工具</h3>
            <ul>
                <li>电脑工具软件（已下载的.zip文件）</li>
                <li>需要解锁的iPad/iPhone设备</li>
                <li>USB数据线</li>
                <li>Windows 10/11或macOS系统</li>
                <li>iTunes最新版本</li>
            </ul>
            
            <h3>操作流程</h3>
            <ol>
                <li>解压下载的.zip文件到任意文件夹</li>
                <li>安装并运行电脑工具主程序</li>
                <li>使用USB线连接设备到电脑</li>
                <li>在软件中识别并选择连接的设备</li>
                <li>选择需要解锁的功能模块</li>
                <li>点击"开始破解"按钮</li>
                <li>等待破解过程完成（设备可能自动重启）</li>
                <li>验证解锁功能是否生效</li>
            </ol>
            
            <h3>支持的功能</h3>
            <ul>
                <li>应用多开功能</li>
                <li>系统主题自定义</li>
                <li>高级权限获取</li>
                <li>隐藏功能解锁</li>
                <li>性能优化调整</li>
            </ul>
            
            <h3>重要提醒</h3>
            <div style="background: rgba(250, 128, 114, 0.12); border-left: 4px solid #FA8072; padding: 15px; margin: 15px 0; border-radius: 4px;">
                <p style="color: #FA8072; font-weight: 700; margin-bottom: 8px;">⚠️ 警告：</p>
                <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 10px;">破解设备可能违反设备保修条款，并存在一定风险。建议操作前：</p>
                <ul style="color: rgba(255, 255, 255, 0.85);">
                    <li>完整备份设备数据</li>
                    <li>确保设备电量充足（建议80%以上）</li>
                    <li>了解可能的风险和后果</li>
                    <li>仅用于合法学习研究目的</li>
                </ul>
            </div>
            
            <div style="background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50; padding: 15px; margin: 20px 0; border-radius: 4px;">
                <p style="color: #4CAF50; font-weight: 600; margin-bottom: 8px;">
                    <i class="fas fa-download" style="margin-right: 8px;"></i>
                    相关软件下载
                </p>
                <p style="color: rgba(255, 255, 255, 0.85);">
                    本文提到的电脑工具软件可以在下载页面获取。点击下方按钮前往下载。
                </p>
            </div>
        `
    },
    '安卓灵动岛软件配置教程': {
        id: 'android-dynamic-island-guide',
        title: '安卓灵动岛软件配置教程',
        date: '2024-03-22',
        readTime: '15分钟阅读',
        category: '安卓定制',
        image: 'images/lddb.jpg',
        downloadUrl: 'https://share.feijipan.com/s/dQZqP5om?code=LYZ6',
        content: `
            <h3>什么是灵动岛？</h3>
            <p>灵动岛是苹果iPhone 14 Pro系列引入的创新交互设计，本软件将其移植到安卓设备，提供类似的使用体验。</p>
            
            <h3>安装前准备</h3>
            <ul>
                <li>安卓8.0或更高版本系统</li>
                <li>开启"未知来源应用"安装权限</li>
                <li>下载灵动岛软件.apk文件</li>
                <li>确保设备有足够存储空间</li>
            </ul>
            
            <h3>安装步骤</h3>
            <ol>
                <li>在文件管理器中找到下载的.apk文件</li>
                <li>点击安装，允许所需权限</li>
                <li>安装完成后不要立即打开</li>
                <li>进入"设置 > 应用管理"找到灵动岛应用</li>
                <li>开启"显示在其他应用上层"权限</li>
                <li>开启"无障碍服务"权限</li>
                <li>重启设备</li>
            </ol>
            
            <h3>基础配置</h3>
            <ol>
                <li>打开灵动岛应用</li>
                <li>进入"设置"菜单</li>
                <li>调整灵动岛位置和大小</li>
                <li>选择显示的通知类型</li>
                <li>自定义动画效果</li>
                <li>设置交互手势</li>
                <li>保存配置并启用</li>
            </ol>
            
            <h3>高级功能设置</h3>
            <ul>
                <li><strong style="color: #FA8072;">音乐控制：</strong>显示当前播放的音乐并支持控制</li>
                <li><strong style="color: #FA8072;">通知预览：</strong>在灵动岛中预览通知内容</li>
                <li><strong style="color: #FA8072;">电量显示：</strong>实时显示设备电量状态</li>
                <li><strong style="color: #FA8072;">快捷操作：</strong>快速启动常用功能</li>
                <li><strong style="color: #FA8072;">主题自定义：</strong>更换灵动岛颜色和样式</li>
            </ul>
            
            <h3>故障排除</h3>
            <div style="background: rgba(250, 128, 114, 0.08); border-radius: 8px; padding: 20px; margin: 20px 0;">
                <div style="margin-bottom: 15px;">
                    <p><strong style="color: #FA8072;">问题：</strong>灵动岛不显示<br>
                    <strong style="color: #FA8072;">解决：</strong>检查是否开启所需权限，重启应用或设备。</p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <p><strong style="color: #FA8072;">问题：</strong>通知不显示在灵动岛<br>
                    <strong style="color: #FA8072;">解决：</strong>在应用设置中启用对应应用的通知权限。</p>
                </div>
                
                <div>
                    <p><strong style="color: #FA8072;">问题：</strong>动画卡顿<br>
                    <strong style="color: #FA8072;">解决：</strong>降低动画质量或关闭不必要的特效。</p>
                </div>
            </div>
            
            <div style="background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50; padding: 15px; margin: 20px 0; border-radius: 4px;">
                <p style="color: #4CAF50; font-weight: 600; margin-bottom: 8px;">
                    <i class="fas fa-download" style="margin-right: 8px;"></i>
                    相关软件下载
                </p>
                <p style="color: rgba(255, 255, 255, 0.85);">
                    本文提到的安卓灵动岛软件可以在下载页面获取。点击下方按钮前往下载。
                </p>
            </div>
        `
    }
};

// 当前文章变量
let currentArticle = null;
// 贪吃蛇游戏实例
let snakeGame = null;

// ========== 贪吃蛇游戏逻辑 ==========
class SnakeGame {
    constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        if (!this.canvas) {
            console.error('游戏画布未找到:', canvasId);
            return;
        }
        
        this.ctx = this.canvas.getContext('2d');
        this.gridSize = 20;
        this.snake = [];
        this.food = { x: 0, y: 0 };
        this.direction = 'right';
        this.nextDirection = 'right';
        this.score = 0;
        this.highScore = parseInt(localStorage.getItem('snakeHighScore')) || 0;
        this.level = 1;
        this.speed = 150; // 初始速度（毫秒）
        this.gameInterval = null;
        this.isPaused = false;
        this.gameRunning = false;
        
        // 边缘安全距离
        this.edgeSafeDistance = 2;
        
        // 确保画布有正确的尺寸
        this.resizeCanvas();
        
        // 监听窗口大小变化
        window.addEventListener('resize', () => {
            this.resizeCanvas();
            if (this.gameRunning) {
                this.draw();
            }
        });
        
        // 初始化游戏
        this.init();
    }
    
    resizeCanvas() {
        if (!this.canvas || !this.canvas.parentElement) return;
        
        const container = this.canvas.parentElement;
        this.canvas.width = container.clientWidth;
        this.canvas.height = container.clientHeight;
        
        // 移动端优化：确保画布尺寸合理
        if (window.innerWidth <= 768) {
            // 移动端限制最大尺寸
            const maxWidth = Math.min(this.canvas.width, 600);
            const maxHeight = Math.min(this.canvas.height, 400);
            this.canvas.width = maxWidth;
            this.canvas.height = maxHeight;
        }
    }
    
    init() {
        if (!this.canvas) return;
        
        // 初始化蛇的位置
        this.snake = [
            { x: 10, y: 10 },
            { x: 9, y: 10 },
            { x: 8, y: 10 }
        ];
        
        // 生成第一个食物
        this.generateFood();
        
        // 绘制初始游戏状态
        this.draw();
        
        // 更新高分显示
        this.updateHighScoreDisplay();
        
        // 更新难度显示
        this.updateDifficultyDisplay();
    }
    
    updateHighScoreDisplay() {
        const highScoreElement = document.getElementById('highScore');
        if (highScoreElement) {
            highScoreElement.textContent = this.highScore;
        }
    }
    
    updateDifficultyDisplay() {
        const difficultyElement = document.getElementById('difficultyValue');
        const difficultySelect = document.getElementById('difficulty');
        
        if (difficultyElement && difficultySelect) {
            const selectedOption = difficultySelect.options[difficultySelect.selectedIndex];
            difficultyElement.textContent = selectedOption.text;
        }
    }
    
    start() {
        if (this.gameRunning && !this.isPaused) return;
        
        this.gameRunning = true;
        this.isPaused = false;
        
        console.log('游戏开始');
        
        // 隐藏开始屏幕
        const gameStartScreen = document.getElementById('gameStart');
        if (gameStartScreen) {
            gameStartScreen.style.display = 'none';
        }
        
        // 隐藏游戏结束屏幕
        const gameOverScreen = document.getElementById('gameOver');
        if (gameOverScreen) {
            gameOverScreen.style.display = 'none';
        }
        
        // 启用暂停按钮
        const pauseBtn = document.getElementById('pauseGame');
        if (pauseBtn) {
            pauseBtn.disabled = false;
        }
        
        // 设置游戏循环
        if (this.gameInterval) clearInterval(this.gameInterval);
        
        // 根据难度设置速度
        const difficulty = document.getElementById('difficulty')?.value || 'medium';
        this.setSpeedByDifficulty(difficulty);
        
        this.gameInterval = setInterval(() => {
            if (!this.isPaused) {
                this.update();
                this.draw();
            }
        }, this.speed);
    }
    
    pause() {
        this.isPaused = !this.isPaused;
        const pauseBtn = document.getElementById('pauseGame');
        
        if (pauseBtn) {
            const pauseIcon = pauseBtn.querySelector('i');
            const pauseText = pauseBtn.querySelector('span');
            
            if (this.isPaused) {
                if (pauseIcon) pauseIcon.className = 'fas fa-play';
                if (pauseText) pauseText.textContent = '继续';
                console.log('游戏暂停');
            } else {
                if (pauseIcon) pauseIcon.className = 'fas fa-pause';
                if (pauseText) pauseText.textContent = '暂停';
                console.log('游戏继续');
            }
        }
    }
    
    restart() {
        console.log('游戏重新开始');
        
        // 重置游戏状态
        this.score = 0;
        this.level = 1;
        this.direction = 'right';
        this.nextDirection = 'right';
        this.isPaused = false;
        this.gameRunning = false;
        
        // 更新显示
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        if (scoreElement) scoreElement.textContent = this.score;
        if (levelElement) levelElement.textContent = this.level;
        
        // 重置按钮状态
        const pauseBtn = document.getElementById('pauseGame');
        if (pauseBtn) {
            pauseBtn.disabled = true;
            const icon = pauseBtn.querySelector('i');
            const text = pauseBtn.querySelector('span');
            if (icon) icon.className = 'fas fa-pause';
            if (text) text.textContent = '暂停';
        }
        
        // 隐藏游戏结束屏幕
        const gameOverScreen = document.getElementById('gameOver');
        if (gameOverScreen) {
            gameOverScreen.style.display = 'none';
        }
        
        // 显示开始屏幕
        const gameStartScreen = document.getElementById('gameStart');
        if (gameStartScreen) {
            gameStartScreen.style.display = 'flex';
        }
        
        // 更新难度显示
        this.updateDifficultyDisplay();
        
        // 重新初始化游戏
        this.init();
        
        // 清除游戏循环
        if (this.gameInterval) {
            clearInterval(this.gameInterval);
            this.gameInterval = null;
        }
        
        console.log('游戏重置完成');
    }
    
    setSpeedByDifficulty(difficulty) {
        // 移动端适当降低速度
        const isMobile = window.innerWidth <= 768;
        const mobileBonus = isMobile ? 20 : 0;
        
        switch(difficulty) {
            case 'easy':
                this.speed = 200 + mobileBonus;
                break;
            case 'medium':
                this.speed = 150 + mobileBonus;
                break;
            case 'hard':
                this.speed = 100 + mobileBonus;
                break;
            case 'expert':
                this.speed = 70 + mobileBonus;
                break;
            default:
                this.speed = 150 + mobileBonus;
        }
        console.log('游戏速度设置:', difficulty, this.speed, '移动端:', isMobile);
    }
    
    generateFood() {
        if (!this.canvas) return;
        
        const gridWidth = Math.floor(this.canvas.width / this.gridSize);
        const gridHeight = Math.floor(this.canvas.height / this.gridSize);
        
        // 生成不在蛇身上的随机位置
        let foodOnSnake;
        let attempts = 0;
        const maxAttempts = 100;
        
        do {
            foodOnSnake = false;
            attempts++;
            
            // 生成在安全区域内的随机位置
            this.food.x = Math.floor(Math.random() * (gridWidth - 2 * this.edgeSafeDistance)) + this.edgeSafeDistance;
            this.food.y = Math.floor(Math.random() * (gridHeight - 2 * this.edgeSafeDistance)) + this.edgeSafeDistance;
            
            // 检查食物是否在蛇身上
            for (let segment of this.snake) {
                if (segment.x === this.food.x && segment.y === this.food.y) {
                    foodOnSnake = true;
                    break;
                }
            }
            
            // 防止无限循环
            if (attempts > maxAttempts) {
                console.warn('生成食物失败，尝试次数过多，放宽边缘限制');
                this.food.x = Math.floor(Math.random() * gridWidth);
                this.food.y = Math.floor(Math.random() * gridHeight);
                break;
            }
        } while (foodOnSnake);
    }
    
    update() {
        if (!this.canvas) return;
        
        // 更新方向
        this.direction = this.nextDirection;
        
        // 根据方向计算新头部位置
        const head = { ...this.snake[0] };
        
        switch(this.direction) {
            case 'up':
                head.y -= 1;
                break;
            case 'down':
                head.y += 1;
                break;
            case 'left':
                head.x -= 1;
                break;
            case 'right':
                head.x += 1;
                break;
        }
        
        const gridWidth = Math.floor(this.canvas.width / this.gridSize);
        const gridHeight = Math.floor(this.canvas.height / this.gridSize);
        
        // 检查是否撞墙
        if (head.x < 0 || head.x >= gridWidth ||
            head.y < 0 || head.y >= gridHeight) {
            this.gameOver();
            return;
        }
        
        // 检查是否撞到自己
        for (let segment of this.snake) {
            if (head.x === segment.x && head.y === segment.y) {
                this.gameOver();
                return;
            }
        }
        
        // 添加新头部
        this.snake.unshift(head);
        
        // 检查是否吃到食物
        if (head.x === this.food.x && head.y === this.food.y) {
            // 加分
            this.score += 10;
            const scoreElement = document.getElementById('score');
            if (scoreElement) {
                scoreElement.textContent = this.score;
            }
            
            // 检查是否升级
            const newLevel = Math.floor(this.score / 500) + 1;
            if (newLevel > this.level) {
                this.level = newLevel;
                const levelElement = document.getElementById('level');
                if (levelElement) {
                    levelElement.textContent = this.level;
                }
                
                // 每升一级速度加快
                if (this.speed > 50) {
                    this.speed -= 10;
                    if (this.gameInterval) {
                        clearInterval(this.gameInterval);
                        this.gameInterval = setInterval(() => {
                            if (!this.isPaused) {
                                this.update();
                                this.draw();
                            }
                        }, this.speed);
                    }
                }
            }
            
            // 生成新食物
            this.generateFood();
        } else {
            // 如果没有吃到食物，移除尾部
            this.snake.pop();
        }
    }
    
    draw() {
        if (!this.canvas || !this.ctx) return;
        
        // 清空画布
        this.ctx.fillStyle = '#1a1a2e';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // 绘制网格（可选）
        this.drawGrid();
        
        // 绘制蛇
        this.snake.forEach((segment, index) => {
            this.ctx.fillStyle = index === 0 ? '#4CAF50' : '#8BC34A';
            this.ctx.fillRect(
                segment.x * this.gridSize,
                segment.y * this.gridSize,
                this.gridSize - 1,
                this.gridSize - 1
            );
            
            // 绘制蛇眼睛（只在头部）
            if (index === 0) {
                this.ctx.fillStyle = '#000';
                const eyeSize = 4;
                
                // 根据方向绘制眼睛
                if (this.direction === 'right') {
                    this.ctx.fillRect(
                        segment.x * this.gridSize + this.gridSize - 6,
                        segment.y * this.gridSize + 4,
                        eyeSize, eyeSize
                    );
                    this.ctx.fillRect(
                        segment.x * this.gridSize + this.gridSize - 6,
                        segment.y * this.gridSize + this.gridSize - 8,
                        eyeSize, eyeSize
                    );
                } else if (this.direction === 'left') {
                    this.ctx.fillRect(
                        segment.x * this.gridSize + 2,
                        segment.y * this.gridSize + 4,
                        eyeSize, eyeSize
                    );
                    this.ctx.fillRect(
                        segment.x * this.gridSize + 2,
                        segment.y * this.gridSize + this.gridSize - 8,
                        eyeSize, eyeSize
                    );
                } else if (this.direction === 'up') {
                    this.ctx.fillRect(
                        segment.x * this.gridSize + 4,
                        segment.y * this.gridSize + 2,
                        eyeSize, eyeSize
                    );
                    this.ctx.fillRect(
                        segment.x * this.gridSize + this.gridSize - 8,
                        segment.y * this.gridSize + 2,
                        eyeSize, eyeSize
                    );
                } else if (this.direction === 'down') {
                    this.ctx.fillRect(
                        segment.x * this.gridSize + 4,
                        segment.y * this.gridSize + this.gridSize - 6,
                        eyeSize, eyeSize
                    );
                    this.ctx.fillRect(
                        segment.x * this.gridSize + this.gridSize - 8,
                        segment.y * this.gridSize + this.gridSize - 6,
                        eyeSize, eyeSize
                    );
                }
            }
        });
        
        // 绘制食物
        this.ctx.fillStyle = '#FF6347';
        this.ctx.beginPath();
        const centerX = this.food.x * this.gridSize + this.gridSize / 2;
        const centerY = this.food.y * this.gridSize + this.gridSize / 2;
        const radius = this.gridSize / 2 - 2;
        this.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        this.ctx.fill();
        
        // 添加食物光泽效果
        this.ctx.fillStyle = '#FFA07A';
        this.ctx.beginPath();
        this.ctx.arc(centerX - radius/3, centerY - radius/3, radius/3, 0, Math.PI * 2);
        this.ctx.fill();
    }
    
    drawGrid() {
        if (!this.canvas || !this.ctx) return;
        
        this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
        this.ctx.lineWidth = 1;
        
        // 绘制垂直线
        for (let x = 0; x <= this.canvas.width; x += this.gridSize) {
            this.ctx.beginPath();
            this.ctx.moveTo(x, 0);
            this.ctx.lineTo(x, this.canvas.height);
            this.ctx.stroke();
        }
        
        // 绘制水平线
        for (let y = 0; y <= this.canvas.height; y += this.gridSize) {
            this.ctx.beginPath();
            this.ctx.moveTo(0, y);
            this.ctx.lineTo(this.canvas.width, y);
            this.ctx.stroke();
        }
    }
    
    gameOver() {
        console.log('游戏结束，得分:', this.score);
        
        // 停止游戏循环
        clearInterval(this.gameInterval);
        this.gameRunning = false;
        
        // 更新最高分
        if (this.score > this.highScore) {
            this.highScore = this.score;
            localStorage.setItem('snakeHighScore', this.highScore);
            this.updateHighScoreDisplay();
        }
        
        // 显示最终分数
        const finalScoreElement = document.getElementById('finalScore');
        if (finalScoreElement) {
            finalScoreElement.textContent = this.score;
        }
        
        // 显示游戏结束屏幕
        const gameOverScreen = document.getElementById('gameOver');
        if (gameOverScreen) {
            gameOverScreen.style.display = 'flex';
        }
        
        // 禁用暂停按钮
        const pauseBtn = document.getElementById('pauseGame');
        if (pauseBtn) {
            pauseBtn.disabled = true;
        }
    }
    
    changeDirection(newDirection) {
        // 防止直接反向移动
        if ((newDirection === 'up' && this.direction !== 'down') ||
            (newDirection === 'down' && this.direction !== 'up') ||
            (newDirection === 'left' && this.direction !== 'right') ||
            (newDirection === 'right' && this.direction !== 'left')) {
            this.nextDirection = newDirection;
        }
    }
}

// ========== 方向按钮控制函数 ==========
function handleDirectionButtonClick(direction) {
    if (!snakeGame || !snakeGame.gameRunning || snakeGame.isPaused) {
        return;
    }
    
    console.log('方向按钮点击:', direction);
    
    // 添加视觉反馈
    const buttonId = direction + 'Btn';
    const button = document.getElementById(buttonId);
    if (button) {
        // 移动端使用不同的反馈
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            button.style.transform = 'scale(0.9)';
            button.style.opacity = '0.7';
            setTimeout(() => {
                button.style.transform = '';
                button.style.opacity = '';
            }, 150);
        } else {
            button.classList.add('button-press-animation');
            setTimeout(() => {
                button.classList.remove('button-press-animation');
            }, 200);
        }
    }
    
    // 震动反馈（移动设备）
    if (navigator.vibrate && window.innerWidth <= 768) {
        navigator.vibrate(30);
    }
    
    // 改变蛇的方向
    snakeGame.changeDirection(direction);
}

// ========== 页面切换函数 - 修复版 ==========
function switchPage(pageId) {
    console.log('切换到页面:', pageId);
    
    // 隐藏所有页面
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => {
        page.style.display = 'none';
        page.classList.remove('active');
    });
    
    // 显示目标页面
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.style.display = 'block';
        targetPage.classList.add('active');
        console.log('页面显示成功:', pageId);
        
        // 滚动到顶部
        setTimeout(() => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }, 50);
        
        // 更新桌面导航链接状态
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.classList.remove('active');
            const linkPage = link.getAttribute('data-page');
            if (linkPage === pageId) {
                link.classList.add('active');
            }
        });
        
        // 更新移动端底部导航链接状态
        const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
        mobileNavLinks.forEach(link => {
            link.classList.remove('active');
            const linkPage = link.getAttribute('data-page');
            if (linkPage === pageId) {
                link.classList.add('active');
            }
        });
    }
    
    // 如果是游戏页面，确保游戏已初始化
    if (pageId === 'game') {
        setTimeout(() => {
            initGame();
            // 移动端检测和优化
            applyMobileOptimizations();
        }, 100);
    }
    
    return false;
}

// ========== 文章相关函数 ==========
function loadArticle(title) {
    const article = articles[title];
    if (!article) return;
    
    currentArticle = article;
    
    document.getElementById('article-title').textContent = article.title;
    document.getElementById('article-date').textContent = article.date;
    document.getElementById('article-read-time').textContent = article.readTime;
    document.getElementById('article-category').textContent = article.category;
    
    const articleImage = document.getElementById('article-image');
    articleImage.style.backgroundImage = `url('${article.image}')`;
    
    document.getElementById('article-content').innerHTML = article.content;
}

// ========== 下载相关函数 ==========
function goToDownload() {
    if (currentArticle && currentArticle.downloadUrl) {
        switchPage('download');
        window.location.hash = 'download';
        
        setTimeout(() => {
            const articleTitle = currentArticle.title;
            let searchTerm = '';
            
            if (articleTitle.includes('Office')) {
                searchTerm = 'Office激活工具（MAC）';
            } else if (articleTitle.includes('电脑工具') || articleTitle.includes('misakaX')) {
                searchTerm = '电脑工具 iPad&iPhone破解功能软件';
            } else if (articleTitle.includes('安卓灵动岛')) {
                searchTerm = '安卓系统灵动岛软件(破解版)';
            }
            
            if (searchTerm) {
                const downloadItems = document.querySelectorAll('.download-item h3');
                downloadItems.forEach(item => {
                    if (item.textContent.includes(searchTerm)) {
                        const downloadItem = item.closest('.download-item');
                        
                        if (!document.querySelector('#highlight-style')) {
                            const style = document.createElement('style');
                            style.id = 'highlight-style';
                            style.textContent = `
                                @keyframes highlightItem {
                                    0% { 
                                        background: rgba(255, 255, 255, 0.15); 
                                        transform: translateY(0);
                                    }
                                    50% { 
                                        background: rgba(76, 175, 80, 0.3); 
                                        box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
                                        transform: translateY(-5px);
                                    }
                                    100% { 
                                        background: rgba(255, 255, 255, 0.15); 
                                        transform: translateY(0);
                                    }
                                }
                                
                                .highlight-download-item {
                                    animation: highlightItem 2s ease;
                                }
                            `;
                            document.head.appendChild(style);
                        }
                        
                        downloadItem.classList.add('highlight-download-item');
                        
                        setTimeout(() => {
                            downloadItem.classList.remove('highlight-download-item');
                        }, 2000);
                        
                        downloadItem.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                });
            }
        }, 300);
    } else {
        switchPage('download');
        window.location.hash = 'download';
    }
}

// ========== 初始化贪吃蛇游戏 ==========
function initGame() {
    console.log('初始化游戏...');
    
    // 清除现有游戏实例
    if (snakeGame) {
        snakeGame.restart();
    }
    
    // 创建新游戏实例
    snakeGame = new SnakeGame('gameCanvas');
    
    if (!snakeGame.canvas) {
        console.error('无法初始化游戏：画布未找到');
        return;
    }
    
    // ========== 键盘控制 ==========
    document.addEventListener('keydown', (e) => {
        if (!snakeGame || !snakeGame.gameRunning || snakeGame.isPaused) return;
        
        switch(e.key) {
            case 'ArrowUp':
                snakeGame.changeDirection('up');
                e.preventDefault();
                break;
            case 'ArrowDown':
                snakeGame.changeDirection('down');
                e.preventDefault();
                break;
            case 'ArrowLeft':
                snakeGame.changeDirection('left');
                e.preventDefault();
                break;
            case 'ArrowRight':
                snakeGame.changeDirection('right');
                e.preventDefault();
                break;
        }
    });
    
    // ========== 游戏控制按钮事件绑定 ==========
    
    // 开始游戏按钮
    const startGameBtn = document.getElementById('startGame');
    if (startGameBtn) {
        startGameBtn.addEventListener('click', () => {
            console.log('开始游戏按钮点击');
            if (snakeGame) {
                snakeGame.start();
            }
        });
    }
    
    // 开始游戏按钮（屏幕）
    const startFromScreenBtn = document.getElementById('startFromScreen');
    if (startFromScreenBtn) {
        startFromScreenBtn.addEventListener('click', () => {
            console.log('开始游戏按钮（屏幕）点击');
            if (snakeGame) {
                snakeGame.start();
            }
        });
    }
    
    // 暂停/继续游戏按钮
    const pauseGameBtn = document.getElementById('pauseGame');
    if (pauseGameBtn) {
        pauseGameBtn.addEventListener('click', () => {
            console.log('暂停/继续按钮点击');
            if (snakeGame && snakeGame.gameRunning) {
                snakeGame.pause();
            }
        });
    }
    
    // 重新开始按钮
    const restartButtons = document.querySelectorAll('#restartGame, #playAgain');
    restartButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            console.log('重新开始按钮点击:', btn.id);
            if (snakeGame) {
                snakeGame.restart();
                if (btn.id === 'playAgain') {
                    setTimeout(() => {
                        snakeGame.start();
                    }, 100);
                }
            }
        });
    });
    
    // ========== 方向按钮事件绑定 ==========
    const directionButtons = ['up', 'down', 'left', 'right'];
    
    directionButtons.forEach(direction => {
        const button = document.getElementById(direction + 'Btn');
        if (!button) return;
        
        // 点击事件（鼠标）
        button.addEventListener('click', () => {
            handleDirectionButtonClick(direction);
        });
        
        // 触摸事件（移动设备）
        button.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleDirectionButtonClick(direction);
            
            // 添加触摸反馈
            button.style.transform = 'scale(0.9)';
            button.style.opacity = '0.7';
            
            setTimeout(() => {
                button.style.transform = '';
                button.style.opacity = '';
            }, 150);
        }, { passive: false });
        
        // 防止双击缩放
        button.addEventListener('touchend', (e) => {
            e.preventDefault();
        });
    });
    
    // ========== 难度控制 ==========
    
    // 难度显示点击事件
    const difficultyDisplay = document.querySelector('.difficulty-display');
    if (difficultyDisplay) {
        difficultyDisplay.addEventListener('click', () => {
            console.log('难度显示点击');
            const difficultySelect = document.getElementById('difficulty');
            if (difficultySelect) {
                const currentIndex = difficultySelect.selectedIndex;
                const nextIndex = (currentIndex + 1) % difficultySelect.options.length;
                difficultySelect.selectedIndex = nextIndex;
                difficultySelect.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // 难度选择变化
    const difficultySelect = document.getElementById('difficulty');
    if (difficultySelect) {
        difficultySelect.addEventListener('change', (e) => {
            console.log('难度改变:', e.target.value);
            
            const difficultyValue = document.getElementById('difficultyValue');
            if (difficultyValue) {
                difficultyValue.textContent = e.target.options[e.target.selectedIndex].text;
            }
            
            if (snakeGame && snakeGame.gameRunning && !snakeGame.isPaused) {
                snakeGame.setSpeedByDifficulty(e.target.value);
                clearInterval(snakeGame.gameInterval);
                snakeGame.gameInterval = setInterval(() => {
                    if (!snakeGame.isPaused) {
                        snakeGame.update();
                        snakeGame.draw();
                    }
                }, snakeGame.speed);
            }
        });
    }
    
    // ========== 返回按钮 ==========
    const backHomeBtn = document.getElementById('backHome');
    if (backHomeBtn) {
        backHomeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const pageId = backHomeBtn.getAttribute('data-page');
            if (pageId) {
                switchPage(pageId);
                window.location.hash = pageId;
            }
        });
    }
    
    console.log('游戏初始化完成');
}

// ========== 移动端检测和优化 ==========
function isMobileDevice() {
    return (typeof window.orientation !== "undefined") ||
           (navigator.userAgent.indexOf('IEMobile') !== -1) ||
           /Android|webOS|iPhone|iPad|iPod|BlackBerry|Mobile/i.test(navigator.userAgent);
}

// 应用移动端优化
function applyMobileOptimizations() {
    const isMobile = window.innerWidth <= 768 || isMobileDevice();
    
    if (!isMobile) return;
    
    console.log('检测到移动设备，应用优化...');
    
    // 添加移动端class
    document.body.classList.add('is-mobile');
    
    // 调整游戏速度
    if (snakeGame) {
        snakeGame.speed = Math.max(snakeGame.speed, 130);
        console.log('移动端游戏速度调整为:', snakeGame.speed);
    }
    
    // 更新控制提示
    const controlHint = document.querySelector('.control-hint p');
    if (controlHint) {
        controlHint.innerHTML = '<i class="fas fa-mobile-alt"></i> 使用下方方向按钮控制';
    }
    
    // 优化触摸控制
    setupMobileTouchControls();
}

// 设置移动端触摸控制
function setupMobileTouchControls() {
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
    
    mobileNavLinks.forEach(link => {
        // 添加点击事件
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const pageId = this.getAttribute('data-page');
            if (pageId) {
                switchPage(pageId);
                window.location.hash = pageId;
                
                // 添加点击反馈
                this.style.transform = 'scale(0.95)';
                this.style.opacity = '0.8';
                setTimeout(() => {
                    this.style.transform = '';
                    this.style.opacity = '';
                }, 150);
            }
        });
        
        // 添加触摸反馈
        link.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.9)';
            this.style.opacity = '0.7';
        }, { passive: true });
        
        link.addEventListener('touchend', function() {
            this.style.transform = '';
            this.style.opacity = '';
        }, { passive: true });
        
        // 长按显示文字
        let longPressTimer;
        const longPressDuration = 800;
        
        link.addEventListener('touchstart', function(e) {
            e.preventDefault();
            longPressTimer = setTimeout(() => {
                // 长按时显示文字
                const span = this.querySelector('span');
                if (span) {
                    span.style.display = 'block';
                    span.style.opacity = '0';
                    span.style.fontSize = '0.7rem';
                    span.style.marginTop = '2px';
                    span.style.color = 'rgba(255, 255, 255, 0.9)';
                    span.style.textAlign = 'center';
                    span.style.transition = 'opacity 0.3s ease';
                    
                    // 触发重绘
                    void span.offsetWidth;
                    
                    span.style.opacity = '1';
                    
                    // 3秒后隐藏文字
                    setTimeout(() => {
                        if (span.style.opacity === '1') {
                            span.style.opacity = '0';
                            setTimeout(() => {
                                span.style.display = '';
                            }, 300);
                        }
                    }, 3000);
                }
            }, longPressDuration);
        }, { passive: false });
        
        link.addEventListener('touchend', function() {
            clearTimeout(longPressTimer);
        }, { passive: true });
        
        link.addEventListener('touchcancel', function() {
            clearTimeout(longPressTimer);
        }, { passive: true });
    });
}

// 防止移动端缩放
function preventMobileZoom() {
    document.addEventListener('touchstart', function(event) {
        if (event.touches.length > 1) {
            event.preventDefault();
        }
    }, { passive: false });
    
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
}

// ========== 哈希变化监听 - 修复版 ==========
function handleHashChange() {
    const hash = window.location.hash.substring(1);
    console.log('当前哈希:', hash);
    
    // 检查是否是需要处理的页面
    const validPages = ['intro', 'download', 'tutorial', 'game', 'portfolio', 'article-detail'];
    
    if (hash && validPages.includes(hash)) {
        console.log('切换到页面:', hash);
        switchPage(hash);
        return;
    }
    
    if (hash.startsWith('article-')) {
        const articleId = hash.replace('article-', '');
        const article = Object.values(articles).find(a => a.id === articleId);
        if (article) {
            loadArticle(article.title);
            switchPage('article-detail');
            return;
        }
    }
    
    // 如果没有匹配的页面，保持当前页面或默认为介绍页
    const currentActivePage = document.querySelector('.page.active');
    if (!currentActivePage || currentActivePage.id === 'intro') {
        switchPage('intro');
    }
}

// ========== 页面初始化 - 修复版 ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('页面初始化开始...');
    
    // ========== 创建移动端底部导航栏 ==========
    function createMobileBottomNav() {
        // 检查是否已经存在
        if (document.querySelector('.mobile-bottom-nav')) {
            return;
        }
        
        const mobileBottomNav = document.createElement('div');
        mobileBottomNav.className = 'mobile-bottom-nav';
        mobileBottomNav.innerHTML = `
            <a href="#intro" class="mobile-nav-link active" data-page="intro" data-title="介绍">
                <i class="fas fa-user"></i>
                <span>介绍</span>
            </a>
            <a href="#download" class="mobile-nav-link" data-page="download" data-title="下载">
                <i class="fas fa-download"></i>
                <span>下载</span>
            </a>
            <a href="#tutorial" class="mobile-nav-link" data-page="tutorial" data-title="教程">
                <i class="fas fa-graduation-cap"></i>
                <span>教程</span>
            </a>
            <a href="#portfolio" class="mobile-nav-link" data-page="portfolio" data-title="作品">
                <i class="fas fa-briefcase"></i>
                <span>作品</span>
            </a>
            <a href="#game" class="mobile-nav-link" data-page="game" data-title="游戏">
                <i class="fas fa-gamepad"></i>
                <span>游戏</span>
            </a>
        `;
        
        document.body.appendChild(mobileBottomNav);
        
        // 设置移动端导航
        setupMobileTouchControls();
    }
    
    // ========== 桌面导航链接点击事件 - 修复版 ==========
    document.querySelectorAll('.nav-link').forEach(link => {
        // 移除现有的事件监听器
        const newLink = link.cloneNode(true);
        link.parentNode.replaceChild(newLink, link);
        
        // 重新绑定事件
        newLink.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const pageId = this.getAttribute('data-page');
            if (pageId) {
                console.log('桌面导航点击:', pageId);
                switchPage(pageId);
                window.location.hash = pageId;
            }
        });
    });
    
    // ========== 返回按钮点击事件 ==========
    document.querySelectorAll('.back-home-btn, .back-to-tutorial-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const pageId = this.getAttribute('data-page');
            if (pageId) {
                switchPage(pageId);
                window.location.hash = pageId;
            }
        });
    });
    
    // ========== 文章下载按钮事件 ==========
    const downloadBtn = document.getElementById('downloadArticleBtn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', goToDownload);
    }
    
    // ========== 教程项点击事件 ==========
    document.querySelectorAll('.tutorial-item').forEach(item => {
        item.style.cursor = 'pointer';
        
        item.addEventListener('click', function(e) {
            if (e.target.closest('.meta-item')) return;
            
            const title = this.querySelector('h3').textContent;
            
            if (articles[title]) {
                loadArticle(title);
                switchPage('article-detail');
                window.location.hash = 'article-' + articles[title].id;
            } else {
                alert('抱歉，这篇文章还在创作中，敬请期待！');
            }
        });
    });
    
    // ========== 作品项点击事件 ==========
    document.querySelectorAll('#portfolio .tutorial-item').forEach(item => {
        item.style.cursor = 'pointer';
        
        item.addEventListener('click', function(e) {
            if (e.target.closest('.meta-item')) return;
            
            const title = this.querySelector('h3').textContent;
            
            // 这里可以添加作品详情页面逻辑
            // 暂时显示提示信息
            alert(`查看作品详情: ${title}\n\n功能开发中，敬请期待！`);
        });
    });
    
    // ========== 下载按钮事件 ==========
    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const downloadUrl = this.getAttribute('data-download-url');
            const title = this.closest('.download-item').querySelector('h3').textContent;
            
            if (downloadUrl) {
                const message = document.createElement('div');
                message.className = 'download-message';
                message.innerHTML = `
                    <div class="download-message-content">
                        <i class="fas fa-external-link-alt"></i>
                        <p>即将下载 "${title}"</p>
                        <p class="download-note">正在跳转到下载链接...</p>
                        <div class="download-actions">
                            <button class="confirm-download-btn">确认下载</button>
                            <button class="cancel-download-btn">取消</button>
                        </div>
                    </div>
                `;
                
                message.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.7);
                    backdrop-filter: blur(10px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    animation: fadeIn 0.3s ease;
                `;
                
                document.body.appendChild(message);
                
                message.querySelector('.confirm-download-btn').addEventListener('click', () => {
                    window.open(downloadUrl, '_blank');
                    message.remove();
                });
                
                message.querySelector('.cancel-download-btn').addEventListener('click', () => {
                    message.remove();
                });
                
                message.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.remove();
                    }
                });
            } else {
                alert('下载链接未设置，请联系管理员获取下载地址。');
            }
        });
    });
    
    // ========== 添加移动端优化 ==========
    const isMobile = window.innerWidth <= 768 || isMobileDevice();
    if (isMobile) {
        createMobileBottomNav();
        applyMobileOptimizations();
        preventMobileZoom();
    }
    
    // ========== 监听横竖屏切换 ==========
    let orientationTimeout;
    window.addEventListener('orientationchange', function() {
        clearTimeout(orientationTimeout);
        orientationTimeout = setTimeout(function() {
            // 重新计算布局
            if (snakeGame) {
                snakeGame.resizeCanvas();
                setTimeout(() => {
                    snakeGame.draw();
                }, 100);
            }
            
            // 重新应用移动端优化
            if (window.innerWidth <= 768) {
                applyMobileOptimizations();
            }
        }, 300);
    });
    
    // ========== 优化窗口大小变化响应 ==========
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            // 创建或移除移动端导航栏
            if (window.innerWidth <= 768) {
                createMobileBottomNav();
            } else {
                const mobileNav = document.querySelector('.mobile-bottom-nav');
                if (mobileNav) {
                    mobileNav.remove();
                }
            }
            
            if (snakeGame) {
                snakeGame.resizeCanvas();
                snakeGame.draw();
            }
            
            // 如果是移动端尺寸，应用优化
            if (window.innerWidth <= 768) {
                applyMobileOptimizations();
            }
        }, 200);
    });
    
    // ========== 初始页面加载 ==========
    // 首先隐藏所有页面
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => {
        page.style.display = 'none';
    });
    
    // 然后根据哈希或默认显示页面
    const initialHash = window.location.hash.substring(1);
    const validPages = ['intro', 'download', 'tutorial', 'game', 'portfolio', 'article-detail'];
    
    if (initialHash && validPages.includes(initialHash)) {
        console.log('初始页面从哈希加载:', initialHash);
        switchPage(initialHash);
    } else {
        console.log('初始页面默认加载: intro');
        switchPage('intro');
    }
    
    // 初始化难度显示
    const difficultyValue = document.getElementById('difficultyValue');
    const difficultySelect = document.getElementById('difficulty');
    if (difficultyValue && difficultySelect) {
        difficultyValue.textContent = difficultySelect.options[difficultySelect.selectedIndex].text;
    }
    
    // 延迟创建移动端导航（如果是移动端）
    setTimeout(() => {
        if (window.innerWidth <= 768) {
            createMobileBottomNav();
        }
    }, 100);
    
    console.log('页面初始化完成');
});

// ========== 监听哈希变化 ==========
window.addEventListener('hashchange', function() {
    console.log('哈希变化事件触发');
    handleHashChange();
});
